rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================================================================
    // HELPER FUNCTIONS
    // ============================================================================================

    // Verificar se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verificar se o usuário é admin
    function isAdmin() {
      return isAuthenticated() &&
        firestore.exists(/databases/(default)/documents/profiles/$(request.auth.uid)) &&
        firestore.get(/databases/(default)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }

    // Verificar se o usuário é fisioterapeuta
    function isPhysiotherapist() {
      return isAuthenticated() &&
        firestore.exists(/databases/(default)/documents/profiles/$(request.auth.uid)) &&
        firestore.get(/databases/(default)/documents/profiles/$(request.auth.uid)).data.role == 'fisioterapeuta';
    }

    // Verificar se o usuário é estagiário
    function isIntern() {
      return isAuthenticated() &&
        firestore.exists(/databases/(default)/documents/profiles/$(request.auth.uid)) &&
        firestore.get(/databases/(default)/documents/profiles/$(request.auth.uid)).data.role == 'estagiario';
    }

    // Verificar se é profissional (fisioterapeuta ou estagiário)
    function isProfessional() {
      return isPhysiotherapist() || isIntern();
    }

    // Verificar tamanho do arquivo (max 10MB)
    function isValidFileSize() {
      return request.resource.size < 10485760;
    }

    // Verificar tamanho do arquivo para PHI (max 50MB - Apple App Store compliance)
    function isValidPHIFileSize() {
      return request.resource.size < 52428800; // 50MB in bytes
    }

    // Verificar tipo de conteúdo permitido
    function isAllowedContentType() {
      return request.resource.contentType.matches('image/.*') ||
             request.resource.contentType == 'application/pdf' ||
             request.resource.contentType == 'video/mp4' ||
             request.resource.contentType == 'video/quicktime';
    }

    // ============================================================================================
    // AVATARES DE USUÁRIOS
    // ============================================================================================

    match /users/{userId}/avatars/{filename} {
      // Leitura: apenas usuários autenticados
      allow read: if isAuthenticated();

      // Escrita: apenas o próprio usuário ou admin
      allow write: if (isAuthenticated() && request.auth.uid == userId) ||
                     isAdmin();
    }

    // ============================================================================================
    // FOTOS DE PACIENTES (PHI - Protected Health Information)
    // Apple App Store Compliance: Requirement 2.4
    // ============================================================================================

    match /patients/{patientId}/photos/{photoId}/{filename} {
      // Leitura: apenas o profissional que é dono do paciente (userId-based access control)
      // PHI deve ser acessível apenas pelo profissional responsável
      allow read: if isAuthenticated() &&
                     firestore.exists(/databases/(default)/documents/patients/$(patientId)) &&
                     firestore.get(/databases/(default)/documents/patients/$(patientId)).data.userId == request.auth.uid;

      // Escrita: apenas o profissional que é dono do paciente
      allow write: if isAuthenticated() &&
                      firestore.exists(/databases/(default)/documents/patients/$(patientId)) &&
                      firestore.get(/databases/(default)/documents/patients/$(patientId)).data.userId == request.auth.uid &&
                      isValidPHIFileSize() &&
                      isAllowedContentType();
    }

    // ============================================================================================
    // ANEXOS DE NOTAS SOAP (PHI - Protected Health Information)
    // Apple App Store Compliance: Requirement 2.4
    // ============================================================================================

    match /soap-notes/{soapNoteId}/attachments/{filename} {
      // Leitura: apenas o profissional que criou a nota SOAP
      allow read: if isAuthenticated() &&
                     firestore.exists(/databases/(default)/documents/soap_notes/$(soapNoteId)) &&
                     firestore.get(/databases/(default)/documents/soap_notes/$(soapNoteId)).data.userId == request.auth.uid;

      // Escrita: apenas o profissional que criou a nota SOAP
      allow write: if isAuthenticated() &&
                      firestore.exists(/databases/(default)/documents/soap_notes/$(soapNoteId)) &&
                      firestore.get(/databases/(default)/documents/soap_notes/$(soapNoteId)).data.userId == request.auth.uid &&
                      isValidPHIFileSize() &&
                      isAllowedContentType();
    }

    // ============================================================================================
    // FOTOS DE EVOLUÇÃO (ANTES/DEPOIS)
    // ============================================================================================

    match /patients/{patientId}/evolutions/{evolutionId}/{filename} {
      // Leitura: profissionais envolvidos e paciente próprio
      allow read: if isProfessional() ||
                     (isAuthenticated() && request.auth.uid == patientId) ||
                     isAdmin();

      // Escrita: apenas profissionais (PHI - use 50MB limit)
      allow write: if isProfessional() &&
                     isValidPHIFileSize() &&
                     isAllowedContentType();
    }

    // ============================================================================================
    // EXERCÍCIOS (VÍDEOS E IMAGENS)
    // ============================================================================================

    match /exercises/{exerciseId}/{filename} {
      // Leitura: todos autenticados (biblioteca de exercícios)
      allow read: if isAuthenticated();

      // Escrita: apenas profissionais e admin
      allow write: if isProfessional() || isAdmin();
    }

    // Mídia migrada do Supabase (exercise-media/{id}/image.ext, thumbnail.ext, video.ext)
    // Leitura pública para biblioteca de exercícios (thumbnails e imagens)
    match /exercise-media/{exerciseId}/{filename} {
      allow read: if true; // Público para permitir carregamento direto de imagens em <img> tags
      allow write: if false;
    }

    // ============================================================================================
    // DOCUMENTOS MÉDICOS (PDF, IMAGENS)
    // ============================================================================================

    match /patients/{patientId}/documents/{documentId}/{filename} {
      // Leitura: profissionais envolvidos e paciente próprio
      allow read: if isProfessional() ||
                     (isAuthenticated() && request.auth.uid == patientId) ||
                     isAdmin();

      // Escrita: apenas profissionais (PHI - use 50MB limit)
      allow write: if isProfessional() &&
                     isValidPHIFileSize() &&
                     isAllowedContentType();
    }

    // ============================================================================================
    // RELATÓRIOS E EXPORTAÇÕES
    // ============================================================================================

    match /reports/{reportId}/{filename} {
      // Leitura: admin e usuário que gerou
      allow read: if isAdmin() ||
                     (isAuthenticated() && request.auth.uid == firestore.get(/databases/(default)/documents/reports/$(reportId)).data.createdBy);

      // Escrita: apenas via Cloud Function (admin service)
      allow write: if false; // Apenas via Cloud Function
    }

    // ============================================================================================
    // BACKUPS DO SISTEMA
    // ============================================================================================

    match /backups/{filename} {
      // Acesso: apenas admin
      allow read, write: if isAdmin();
    }

    // ============================================================================================
    // TEMPORÁRIOS (UPLOADS EM ANDAMENTO)
    // ============================================================================================

    match /temp/{userId}/{filename} {
      // Leitura: apenas o próprio usuário
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Escrita: usuário pode fazer upload temporário
      // Será movido para local definitivo via Cloud Function
      allow write: if isAuthenticated() &&
                     request.auth.uid == userId &&
                     isValidFileSize() &&
                     isAllowedContentType();
    }

    // ============================================================================================
    // ASSETS PÚBLICOS (LOGOS, IMAGENS DE MARKETING)
    // ============================================================================================

    match /public/{filename} {
      // Leitura: apenas usuários autenticados
      allow read: if isAuthenticated();

      // Escrita: apenas admin
      allow write: if isAdmin();
    }

    // ============================================================================================
    // DEFAULT DENY
    // ============================================================================================

    // Negar qualquer acesso não explicitamente permitido
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
