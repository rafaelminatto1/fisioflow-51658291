<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DraggableGrid Test - Standalone</title>
    <style>
        /* Import the CSS fixes from index.css */
        .react-grid-layout {
            position: relative;
            margin: 0 auto;
            width: 1200px;
            /* Ensure border-box is applied */
            box-sizing: border-box;
        }

        .react-grid-layout > .react-grid-item {
            box-sizing: border-box !important;
            transition: transform 200ms ease-out;
        }

        .react-grid-placeholder {
            background: hsl(var(--primary) / 0.1) !important;
            border: 2px dashed hsl(var(--primary) / 0.5) !important;
            border-radius: 0.5rem;
            transition: all 150ms ease-out;
            box-sizing: border-box !important;
        }

        .react-resizable-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: hsl(222, 47%, 60% / 0.2);
            border-radius: 4px;
            transition: background 150ms ease-out;
            z-index: 10;
            bottom: 0;
            right: 0;
            cursor: se-resize;
        }

        .react-resizable-handle:hover {
            background: hsl(222, 47%, 60% / 0.4);
        }

        /* Grid widget styles */
        .grid-widget {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: box-shadow 150ms ease-out;
        }

        .grid-widget:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .grid-widget.grabbed {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
            transform: scale(1.01);
        }

        .widget-header {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f9fafb;
        }

        .drag-handle {
            cursor: grab;
            padding: 0.375rem;
            border-radius: 0.375rem;
            color: #6b7280;
            transition: all 150ms ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-handle:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: scale(1.1);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .widget-title {
            font-size: 0.875rem;
            font-weight: 500;
            flex: 1;
        }

        .widget-content {
            padding: 1rem;
            flex: 1;
            overflow: auto;
        }

        /* Test status */
        .test-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            font-size: 0.875rem;
        }

        .test-status h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }

        .test-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .test-item.pass {
            color: #059669;
        }

        .test-item.fail {
            color: #dc2626;
        }

        .test-item.pending {
            color: #6b7280;
        }

        /* Layout info */
        .layout-info {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: #1f2937;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.75rem;
            max-width: 250px;
        }

        /* Control panel */
        .control-panel {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .control-panel button {
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 150ms ease-out;
        }

        .control-panel button:hover {
            background: #f9fafb;
        }

        .control-panel button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .control-panel button.primary:hover {
            background: #2563eb;
        }

        /* Highlight margin spacing */
        .margin-highlight {
            position: absolute;
            background: rgba(59, 130, 246, 0.2);
            border: 1px dashed #3b82f6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div style="padding: 2rem; background: #f9fafb; min-height: 100vh;">
        <h1 style="margin: 0 0 1rem 0; text-align: center;">DraggableGrid Test</h1>
        <p style="text-align: center; color: #6b7280; margin-bottom: 2rem;">
            Testing margin spacing, drag & drop, and resize functionality
        </p>

        <div id="grid" class="react-grid-layout">
            <!-- Widgets will be created here -->
        </div>
    </div>

    <div class="control-panel">
        <h3 style="margin: 0 0 0.5rem 0;">Controls</h3>
        <button id="toggleEdit" class="primary">Enable Edit Mode</button>
        <button id="resetLayout">Reset Layout</button>
        <button id="highlightMargins">Highlight Margins</button>
        <button id="runTests">Run Tests</button>
    </div>

    <div class="test-status" id="testStatus">
        <h3>Test Results</h3>
        <div class="test-item pending" id="test-margin">✓ Margin spacing: Pending</div>
        <div class="test-item pending" id="test-box-sizing">✓ Box-sizing: Pending</div>
        <div class="test-item pending" id="test-z-index">✓ Resize handle z-index: Pending</div>
        <div class="test-item pending" id="test-drag">✓ Drag functionality: Pending</div>
    </div>

    <div class="layout-info" id="layoutInfo">
        <div>Grid items: <span id="itemCount">0</span></div>
        <div>Editable: <span id="editableStatus">No</span></div>
        <div>Margin: [16, 16]</div>
        <div>Container padding: [0, 0]</div>
    </div>

    <script>
        // Simulated react-grid-layout behavior for testing
        const grid = document.getElementById('grid');
        let isEditable = false;
        let draggedItem = null;
        let offset = { x: 0, y: 0 };
        let layout = [];

        // Widget definitions (matching EvolutionDraggableGrid)
        const widgetDefs = [
            { id: 'pain-scale', title: 'Nível de Dor', w: 6, h: 4, x: 0, y: 0, minW: 4, minH: 3, color: '#fef3c7' },
            { id: 'exercises', title: 'Exercícios da Sessão', w: 6, h: 4, x: 6, y: 0, minW: 4, minH: 3, color: '#dbeafe' },
            { id: 'subjective', title: 'Subjetivo', w: 6, h: 5, x: 0, y: 4, minW: 4, minH: 4, color: '#e0e7ff' },
            { id: 'objective', title: 'Objetivo', w: 6, h: 5, x: 6, y: 4, minW: 4, minH: 4, color: '#fae8ff' },
            { id: 'assessment', title: 'Avaliação', w: 6, h: 5, x: 0, y: 9, minW: 4, minH: 4, color: '#fce7f3' },
            { id: 'plan', title: 'Plano', w: 6, h: 5, x: 6, y: 9, minW: 4, minH: 4, color: '#d1fae5' },
        ];

        const COL_WIDTH = 96; // Approximate column width
        const ROW_HEIGHT = 50;
        const MARGIN_H = 16;
        const MARGIN_V = 16;

        function createWidget(def) {
            const item = document.createElement('div');
            item.className = 'react-grid-item';
            item.id = def.id;
            item.dataset.grid = JSON.stringify({
                i: def.id,
                w: def.w,
                h: def.h,
                x: def.x,
                y: def.y,
                minW: def.minW,
                minH: def.minH,
                maxW: def.w + 4
            });

            const width = def.w * COL_WIDTH + (def.w - 1) * MARGIN_H;
            const height = def.h * ROW_HEIGHT + (def.h - 1) * MARGIN_V;
            const left = def.x * (COL_WIDTH + MARGIN_H);
            const top = def.y * (ROW_HEIGHT + MARGIN_V);

            item.style.cssText = `
                position: absolute;
                left: ${left}px;
                top: ${top}px;
                width: ${width}px;
                height: ${height}px;
                transform: translate(0px, 0px);
            `;

            item.innerHTML = `
                <div class="grid-widget" style="background: ${def.color}">
                    <div class="widget-header">
                        <div class="drag-handle" title="Arraste para mover">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="8" y2="18"></line>
                                <line x1="16" y1="6" x2="16" y2="18"></line>
                            </svg>
                        </div>
                        <span class="widget-title">${def.title}</span>
                        <small style="color: #6b7280;">${def.w}×${def.h}</small>
                    </div>
                    <div class="widget-content">
                        <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
                            Position: (${def.x}, ${def.y})<br>
                            Size: ${def.w} cols × ${def.h} rows
                        </p>
                    </div>
                    <div class="react-resizable-handle" title="Arraste para redimensionar"></div>
                </div>
            `;

            return item;
        }

        function initGrid() {
            grid.innerHTML = '';
            layout = [];

            widgetDefs.forEach(def => {
                const item = createWidget(def);
                grid.appendChild(item);
                layout.push({ ...def, element: item });

                // Add drag event listeners
                const dragHandle = item.querySelector('.drag-handle');
                dragHandle.addEventListener('mousedown', (e) => onDragStart(e, item, def));
                dragHandle.addEventListener('touchstart', (e) => onDragStart(e, item, def), { passive: false });

                // Add resize event listeners
                const resizeHandle = item.querySelector('.react-resizable-handle');
                resizeHandle.addEventListener('mousedown', (e) => onResizeStart(e, item, def));
                resizeHandle.addEventListener('touchstart', (e) => onResizeStart(e, item, def), { passive: false });
            });

            updateLayoutInfo();
        }

        function onDragStart(e, item, def) {
            if (!isEditable) return;
            e.preventDefault();

            draggedItem = { element: item, def, type: 'drag' };
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const rect = item.getBoundingClientRect();
            offset.x = clientX - rect.left;
            offset.y = clientY - rect.top;

            item.querySelector('.grid-widget').classList.add('grabbed');

            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchmove', onDragMove, { passive: false });
            document.addEventListener('touchend', onDragEnd);
        }

        function onDragMove(e) {
            if (!draggedItem || draggedItem.type !== 'drag') return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const gridRect = grid.getBoundingClientRect();
            let x = clientX - gridRect.left - offset.x;
            let y = clientY - gridRect.top - offset.y;

            // Snap to grid
            const colWidth = COL_WIDTH + MARGIN_H;
            const rowHeight = ROW_HEIGHT + MARGIN_V;

            x = Math.round(x / colWidth) * colWidth;
            y = Math.round(y / rowHeight) * rowHeight;

            // Constrain to grid
            x = Math.max(0, Math.min(x, gridRect.width - draggedItem.element.offsetWidth));
            y = Math.max(0, y);

            draggedItem.element.style.left = x + 'px';
            draggedItem.element.style.top = y + 'px';
            draggedItem.element.style.transform = 'translate(0px, 0px)';
        }

        function onDragEnd(e) {
            if (!draggedItem) return;

            draggedItem.element.querySelector('.grid-widget').classList.remove('grabbed');

            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            document.removeEventListener('touchmove', onDragMove);
            document.removeEventListener('touchend', onDragEnd);

            document.getElementById('test-drag').className = 'test-item pass';
            document.getElementById('test-drag').textContent = '✓ Drag functionality: PASS';

            draggedItem = null;
        }

        function onResizeStart(e, item, def) {
            if (!isEditable) return;
            e.preventDefault();
            e.stopPropagation();

            draggedItem = { element: item, def, type: 'resize', startX: e.clientX, startY: e.clientY, startWidth: item.offsetWidth, startHeight: item.offsetHeight };

            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('mouseup', onResizeEnd);
        }

        function onResizeMove(e) {
            if (!draggedItem || draggedItem.type !== 'resize') return;

            const dx = e.clientX - draggedItem.startX;
            const dy = e.clientY - draggedItem.startY;

            const newWidth = draggedItem.startWidth + dx;
            const newHeight = draggedItem.startHeight + dy;

            // Snap to grid
            const colWidth = COL_WIDTH + MARGIN_H;
            const rowHeight = ROW_HEIGHT + MARGIN_V;

            const newCols = Math.round(newWidth / colWidth);
            const newRows = Math.round(newHeight / rowHeight);

            draggedItem.element.style.width = (newCols * colWidth - MARGIN_H) + 'px';
            draggedItem.element.style.height = (newRows * rowHeight - MARGIN_V) + 'px';
        }

        function onResizeEnd() {
            draggedItem = null;
            document.removeEventListener('mousemove', onResizeMove);
            document.removeEventListener('mouseup', onResizeEnd);
        }

        function updateLayoutInfo() {
            document.getElementById('itemCount').textContent = layout.length;
            document.getElementById('editableStatus').textContent = isEditable ? 'Yes' : 'No';
        }

        function toggleEditMode() {
            isEditable = !isEditable;
            const btn = document.getElementById('toggleEdit');

            if (isEditable) {
                btn.textContent = 'Disable Edit Mode';
                btn.classList.remove('primary');
                grid.querySelectorAll('.drag-handle, .react-resizable-handle').forEach(el => {
                    el.style.visibility = 'visible';
                });
            } else {
                btn.textContent = 'Enable Edit Mode';
                btn.classList.add('primary');
            }

            updateLayoutInfo();
        }

        function resetLayout() {
            initGrid();
            isEditable = false;
            document.getElementById('toggleEdit').textContent = 'Enable Edit Mode';
            document.getElementById('toggleEdit').classList.add('primary');
        }

        function highlightMargins() {
            // Remove existing highlights
            document.querySelectorAll('.margin-highlight').forEach(el => el.remove());

            layout.forEach((item, i) => {
                const rect = item.element.getBoundingClientRect();
                const gridRect = grid.getBoundingClientRect();

                // Highlight right margin
                if (item.def.x + item.def.w < 12) {
                    const highlight = document.createElement('div');
                    highlight.className = 'margin-highlight';
                    highlight.style.cssText = `
                        position: fixed;
                        left: ${rect.right}px;
                        top: ${rect.top}px;
                        width: ${MARGIN_H}px;
                        height: ${rect.height}px;
                        pointer-events: none;
                    `;
                    highlight.title = `Horizontal margin (${MARGIN_H}px)`;
                    document.body.appendChild(highlight);
                }

                // Highlight bottom margin
                const highlight = document.createElement('div');
                highlight.className = 'margin-highlight';
                highlight.style.cssText = `
                    position: fixed;
                    left: ${rect.left}px;
                    top: ${rect.bottom}px;
                    width: ${rect.width}px;
                    height: ${MARGIN_V}px;
                    pointer-events: none;
                `;
                highlight.title = `Vertical margin (${MARGIN_V}px)`;
                document.body.appendChild(highlight);
            });
        }

        function runTests() {
            // Test 1: Margin spacing
            const item1 = layout[0].element.getBoundingClientRect();
            const item2 = layout[1].element.getBoundingClientRect();
            const horizontalGap = item2.left - item1.right;

            if (horizontalGap >= MARGIN_H - 2) { // Allow small rounding error
                document.getElementById('test-margin').className = 'test-item pass';
                document.getElementById('test-margin').textContent = `✓ Margin spacing: PASS (gap: ${horizontalGap.toFixed(0)}px)`;
            } else {
                document.getElementById('test-margin').className = 'test-item fail';
                document.getElementById('test-margin').textContent = `✗ Margin spacing: FAIL (gap: ${horizontalGap.toFixed(0)}px, expected: ${MARGIN_H}px)`;
            }

            // Test 2: Box-sizing
            const computedStyle = window.getComputedStyle(layout[0].element);
            const boxSizing = computedStyle.boxSizing;

            if (boxSizing === 'border-box') {
                document.getElementById('test-box-sizing').className = 'test-item pass';
                document.getElementById('test-box-sizing').textContent = '✓ Box-sizing: PASS (border-box)';
            } else {
                document.getElementById('test-box-sizing').className = 'test-item fail';
                document.getElementById('test-box-sizing').textContent = `✗ Box-sizing: FAIL (${boxSizing})`;
            }

            // Test 3: Resize handle z-index
            const resizeHandle = layout[0].element.querySelector('.react-resizable-handle');
            const zIndex = window.getComputedStyle(resizeHandle).zIndex;

            if (parseInt(zIndex) >= 10 || zIndex === '10') {
                document.getElementById('test-z-index').className = 'test-item pass';
                document.getElementById('test-z-index').textContent = `✓ Resize handle z-index: PASS (${zIndex})`;
            } else {
                document.getElementById('test-z-index').className = 'test-item fail';
                document.getElementById('test-z-index').textContent = `✗ Resize handle z-index: FAIL (${zIndex})`;
            }

            // Test 4: Drag functionality (requires user interaction)
            const testDrag = document.getElementById('test-drag');
            if (testDrag.classList.contains('pass')) {
                // Already passed from user interaction
            } else {
                testDrag.className = 'test-item pending';
                testDrag.textContent = '✓ Drag functionality: Enable edit mode and drag a widget';
            }
        }

        // Event listeners
        document.getElementById('toggleEdit').addEventListener('click', toggleEditMode);
        document.getElementById('resetLayout').addEventListener('click', resetLayout);
        document.getElementById('highlightMargins').addEventListener('click', highlightMargins);
        document.getElementById('runTests').addEventListener('click', runTests);

        // Initialize
        initGrid();
    </script>
</body>
</html>
