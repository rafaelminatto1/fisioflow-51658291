rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================================
    // HELPER FUNCTIONS (OPTIMIZED WITH CUSTOM CLAIMS)
    // ============================================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check role using Custom Claims (No Firestore read required!)
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    // Check if user is admin (Custom Claim)
    function isAdmin() {
      return isAuthenticated() && (request.auth.token.admin == true || request.auth.token.role == 'admin' || request.auth.token.isAdmin == true);
    }

    // Check if user is professional (Custom Claim: physiotherapist, intern, owner, admin)
    function isProfessional() {
      return isAuthenticated() && (request.auth.token.isProfessional == true || 
             request.auth.token.role in ['fisioterapeuta', 'estagiario', 'owner', 'admin']);
    }

    // Check if user is patient (Custom Claim)
    function isPatient() {
      return isAuthenticated() && request.auth.token.role == 'paciente';
    }

    // Check if user is owner of the document
    function isOwner(userIdField) {
      return isAuthenticated() && request.auth.uid == resource.data[userIdField];
    }
    
    // Check if user belongs to the same organization (Custom Claim)
    function isSameOrg(orgId) {
      return isAuthenticated() && request.auth.token.organizationId == orgId;
    }

    function canManageSchedule() {
      return isProfessional() || hasRole('recepcionista');
    }

    function canAccessPatientData() {
      return isAdmin() || isProfessional();
    }

    function isValidSize() {
      return request.resource.data.size() < 1000000; // 1MB max per document
    }

    // ============================================================================================
    // USERS COLLECTION
    // ============================================================================================

    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow create: if isAdmin() && isValidSize();
      allow update: if isAdmin() || (isAuthenticated() && request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'emailVerified']));
      allow delete: if isAdmin();
    }
    
    // ============================================================================================
    // ORGANIZATIONS
    // ============================================================================================

    match /organizations {
      allow list: if isAuthenticated();
    }

    match /organizations/{organizationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || (isProfessional() && isSameOrg(organizationId));

      match /automation_logs/{logId} {
        allow read: if isAuthenticated() && isSameOrg(organizationId);
      }

      match /integration_status/{providerId} {
        allow read, write: if isAuthenticated() && isSameOrg(organizationId);
      }
    }
    
    // ============================================================================================
    // PROFILES
    // ============================================================================================
    
    match /profiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId && isValidSize();
      allow update: if isAdmin() || (isAuthenticated() && request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'organization_id', 'permissions']));
      allow delete: if isAdmin();
    }
    
    // ============================================================================================
    // PATIENTS
    // ============================================================================================

    match /patients {
      allow list: if isAdmin() || isProfessional();
    }

    match /patients/{patientId} {
      allow read: if isAdmin() || isProfessional() || (isPatient() && (request.auth.uid == patientId || request.auth.uid == resource.data.userId));
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update: if isProfessional() || isAdmin() || (isPatient() && isOwner('userId'));
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // APPOINTMENTS
    // ============================================================================================

    match /appointments {
      allow list: if isAdmin() || isProfessional();
    }

    match /appointments/{appointmentId} {
      allow read: if isAdmin() || isProfessional() || (isPatient() && (request.auth.uid == resource.data.patientId || request.auth.uid == resource.data.userId));
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // SUB-COLLECTIONS
    // ============================================================================================

    match /patient_surgeries/{docId} { allow read, write: if isAuthenticated(); }
    match /patient_medical_returns/{docId} { allow read, write: if isAuthenticated(); }
    match /patient_pathologies/{docId} { allow read, write: if isAuthenticated(); }
    match /patient_goals/{docId} { allow read, write: if isAuthenticated(); }
    match /soap_records/{docId} { allow read, write: if isAuthenticated(); }
    match /treatment_sessions/{docId} { allow read, write: if isAuthenticated(); }
    match /evolution_measurements/{docId} { allow read, write: if isAuthenticated(); }
    match /pathology_required_measurements/{docId} { allow read, write: if isAuthenticated(); }

    // ============================================================================================
    // EXERCISES & PROTOCOLS
    // ============================================================================================

    match /exercises/{exerciseId} {
      allow read: if isAdmin() || isProfessional();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update: if (isProfessional() && isOwner('createdBy')) || isAdmin();
      allow delete: if isAdmin();
    }

    match /exercise_protocols/{protocolId} {
      allow read: if isAdmin() || isProfessional();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update, delete: if isProfessional() || isAdmin();
    }

    match /exercise_templates/{templateId} {
      allow read: if isAdmin() || isProfessional();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update, delete: if isProfessional() || isAdmin();
    }

    match /exercise_template_items/{itemId} {
      allow read: if isAdmin() || isProfessional();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update, delete: if isProfessional() || isAdmin();
    }

    match /patient_exercises/{assignmentId} {
      allow read: if isAdmin() || isProfessional() || (isPatient() && resource.data.patientId == request.auth.uid);
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /clinical_test_templates/{docId} {
      allow read: if isAdmin() || isProfessional();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update, delete: if isProfessional() || isAdmin();
    }

    // ============================================================================================
    // FINANCIAL
    // ============================================================================================

    match /contas_financeiras/{id} {
        allow read: if isAdmin() || isProfessional();
        allow write: if isAdmin();
    }

    match /payments/{paymentId} {
      allow read, write: if isAdmin();
    }
    
    match /vouchers/{voucherId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if false; 
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // SYSTEM
    // ============================================================================================

    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow update: if isAuthenticated() && request.auth.uid == resource.data.user_id;
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.user_id || isAdmin();
    }

    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /settings/{settingId} {
      allow read: if isAuthenticated() && (!resource.data.isPrivate || isAdmin());
      allow write: if isAdmin();
    }
    
    match /events/{eventId} {
      allow read: if canAccessPatientData() || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isOwner('createdBy') || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /evolutions/{evolutionId} {
      allow read: if canAccessPatientData() || (isPatient() && resource.data.patientId == request.auth.uid) || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isOwner('therapistId') || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /evaluations/{evaluationId} {
      allow read: if canAccessPatientData() || (isPatient() && resource.data.patientId == request.auth.uid) || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isOwner('therapistId') || isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // SCHEDULE SETTINGS
    // ============================================================================================
    
    match /schedule_capacity_config/{docId} {
      allow read: if isAuthenticated();
      allow write: if canManageSchedule();
    }
    match /schedule_business_hours/{docId} {
      allow read, write: if isValidSize() && (isAdmin() || canManageSchedule());
    }
    match /schedule_cancellation_rules/{docId} {
      allow read, write: if isValidSize() && (isAdmin() || canManageSchedule());
    }
    match /schedule_notification_settings/{docId} {
      allow read, write: if isValidSize() && (isAdmin() || canManageSchedule());
    }
    match /schedule_blocked_times/{docId} {
      allow read, write: if isValidSize() && (isAdmin() || canManageSchedule());
    }

    match /waitlist/{waitlistId} {
      allow read: if canManageSchedule();
      allow create: if isValidSize() && canManageSchedule();
      allow update: if canManageSchedule();
      allow delete: if isAdmin();
    }

    match /waitlist_offers/{offerId} {
      allow read: if canManageSchedule();
      allow create, update: if isValidSize() && canManageSchedule();
      allow delete: if isAdmin();
    }

    match /presence/{channelName}/users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId && isValidSize();
    }

    match /wiki_pages/{pageId} {
      allow read: if isAuthenticated() && (isAdmin() || isProfessional());
      allow create, update, delete: if isAdmin() || isProfessional();
    }
    
    match /wiki_categories/{categoryId} {
      allow read: if isAuthenticated() && (isAdmin() || isProfessional());
      allow create, update, delete: if isAdmin() || isProfessional();
    }

    match /user_invitations/{invitationId} {
      allow read, create, update, delete: if isAuthenticated();
    }
    
    match /onboarding_progress/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    match /user_roles/{userId} {
      allow read: if isAdmin() || isProfessional() || (isAuthenticated() && request.auth.uid == userId);
      allow write: if isAdmin();
    }

    // ============================================================================================
    // GAMIFICATION
    // ============================================================================================

    match /patient_gamification/{patientId} {
      allow read: if isAuthenticated();
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /xp_transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isProfessional() || isAdmin();
    }

    match /achievements/{achievementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /achievements_log/{logId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update, delete: if isAdmin();
    }

    match /daily_quests/{questId} {
      allow read: if isAuthenticated();
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /shop_items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /user_inventory/{inventoryId} {
      allow read: if isAuthenticated();
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /gamification_settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================================================================
    // DOCTORS
    // ============================================================================================

    match /doctors {
      allow list: if isAuthenticated();
    }

    match /doctors/{doctorId} {
      allow read: if isAuthenticated();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // MARKETING
    // ============================================================================================

    match /marketing_consents/{patientId} {
      allow read: if isProfessional() || isAdmin() || (isPatient() && request.auth.uid == patientId);
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /marketing_exports/{exportId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update, delete: if isAdmin();
    }

    match /marketing_configs/{configId} {
      allow read: if isProfessional() || isAdmin();
      allow write: if isAdmin() || (isProfessional() && canManageSchedule());
    }

    match /recall_campaigns/{campaignId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /referral_codes/{codeId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update, delete: if isAdmin();
    }

    match /referral_redemptions/{redemptionId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isAuthenticated() && isValidSize();
      allow update, delete: if isAdmin();
    }

    match /fisio_links/{slug} {
      allow read: if isAuthenticated();
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /fisio_link_analytics/{analyticId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isAuthenticated(); 
      allow update, delete: if isAdmin();
    }

    match /content_calendar/{contentId} {
      allow read, create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /gamification_points/{patientId} {
      allow read: if isProfessional() || isAdmin() || (isPatient() && request.auth.uid == patientId);
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /marketing_achievements/{achievementId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update, delete: if isAdmin();
    }

    match /marketing_achievement_log/{logId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isProfessional() || isAdmin();
      allow update, delete: if isAdmin();
    }

    match /marketing_leaderboards/{leaderboardId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================================================================
    // USER SUB-COLLECTIONS (Patient App Data)
    // ============================================================================================

    match /users/{userId}/exercise_plans/{planId} {
      allow read: if isProfessional() || (isAuthenticated() && request.auth.uid == userId);
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /users/{userId}/appointments/{appointmentId} {
      allow read: if isProfessional() || (isAuthenticated() && request.auth.uid == userId);
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    match /users/{userId}/health_data/{dataId} {
      allow read: if isProfessional() || (isAuthenticated() && request.auth.uid == userId);
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/pain_entries/{entryId} {
      allow read: if isProfessional() || (isAuthenticated() && request.auth.uid == userId);
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/exercise_progress/{progressId} {
      allow read: if isProfessional() || (isAuthenticated() && request.auth.uid == userId);
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/notification_settings/{settingId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/profile_photos/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId && isValidSize();
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid));
      allow create: if isAuthenticated() && isValidSize();
      allow update: if isAuthenticated() && exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid));
      allow delete: if isAdmin();
    }

    match /conversations/{conversationId}/participants/{participantId} {
      allow read, write: if isAuthenticated();
    }

    match /conversations/{conversationId}/messages/{messageId} {
      allow read: if isAuthenticated() && exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid));
      allow create: if isAuthenticated() && exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid)) && isValidSize();
      allow update: if isAuthenticated() && request.auth.uid == resource.data.senderId;
      allow delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}