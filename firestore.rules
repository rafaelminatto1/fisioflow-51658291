rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================================
    // HELPER FUNCTIONS
    // ============================================================================================

    // Verificar se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verificadores de papel (Role checkers) com proteção de existência
    // Nota: hasRole pode causar dependência circular quando usado em regras da coleção profiles
    function hasRole(role) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == role;
    }

    // Verificar se o usuário tem perfil no Firestore
    function hasProfile() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid));
    }

    // Verificar se o usuário é admin
    function isAdmin() {
      return request.auth.token.admin == true || request.auth.token.role == 'admin';
    }

    // Acesso emergencial (Bootstrap) - Removido em favor de Custom Claims
    // Para acesso inicial, use o script scripts/set-admin-claim.js
    function isBootstrapAdmin() {
      return isAdmin();
    }
    // UID do bootstrap admin - uso direto quando get(profiles) puder falhar
    function isBootstrapAdminUid() {
      return isAuthenticated() && request.auth.uid == 'sj9b11xOjPT8Q34pPHBMUIPzvQQ2';
    }

    // Verificar se o usuário é fisioterapeuta
    function isPhysiotherapist() {
      return hasRole('fisioterapeuta');
    }

    // Verificar se o usuário é estagiário
    function isIntern() {
      return hasRole('estagiario');
    }

    // Verificar se o usuário é paciente
    function isPatient() {
      return hasRole('paciente');
    }

    // Verificar se é profissional (fisioterapeuta ou estagiário)
    function isProfessional() {
      return isPhysiotherapist() || isIntern();
    }

    // Verificar se é recepcionista
    function isReceptionist() {
      return hasRole('recepcionista');
    }

    // Verificar se é owner (proprietário da clínica)
    function isOwnerRole() {
      return hasRole('owner');
    }

    // Role em user_roles (fallback quando profiles não tem role sincronizado)
    function getUserRolesRole() {
      return isAuthenticated() && exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) ?
        get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role : null;
    }
    // Staff que pode gerenciar agenda: admin, owner, profissional ou recepcionista (profiles ou user_roles)
    function canManageSchedule() {
      return isAdmin() || isOwnerRole() || isProfessional() || isReceptionist() ||
        (isAuthenticated() && getUserRolesRole() in ['admin', 'owner', 'fisioterapeuta', 'estagiario', 'recepcionista']);
    }

    // Fallback: usuário autenticado com perfil em Firestore pode ler/escrever docs da sua organização
    // (cobre perfis vindos do backend/Cloud SQL onde role pode não estar sincronizado)
    function userOrgId() {
      return isAuthenticated() && hasProfile() ?
        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.organization_id : null;
    }
    function canAccessScheduleByOrg(orgId) {
      return isAuthenticated() && hasProfile() && orgId != null && orgId == userOrgId();
    }

    // Verificar se o usuário é o proprietário do documento
    function isOwner(userIdField) {
      return isAuthenticated() &&
        request.auth.uid == resource.data[userIdField];
    }

    // Verificar se o usuário pode acessar dados do paciente
    function canAccessPatientData() {
      return isAdmin() || isProfessional();
    }

    // Verificar tamanho do documento para prevenir ataques
    function isValidSize() {
      return request.resource.data.size() < 1000000; // 1MB max per document
    }

    // ============================================================================================
    // USERS COLLECTION
    // ============================================================================================

    match /users/{userId} {
      // Leitura: admins podem ver todos, usuários podem ver próprio perfil
      allow read: if isAdmin() ||
                     (isAuthenticated() && request.auth.uid == userId);

      // Criação: apenas admins podem criar usuários
      allow create: if isAdmin() && isValidSize();

      // Atualização: admins podem atualizar qualquer um
      // usuários podem atualizar próprio perfil (exceto role)
      allow update: if isAdmin() ||
                      (isAuthenticated() &&
                       request.auth.uid == userId &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'emailVerified']));

      // Deleção: apenas admins
      allow delete: if isAdmin();
    }
    
    // ============================================================================================
    // ORGANIZATIONS COLLECTION (ADDED)
    // ============================================================================================

    match /organizations {
      // Listagem: usuários autenticados podem listar organizações
      allow list: if isAuthenticated();
    }

    match /organizations/{organizationId} {
      // Leitura: usuários autenticados podem ver organizações
      // Isso permite que o frontend busque informações da clínica
      allow read: if isAuthenticated();

      // Criação/Atualização: apenas admin ou profissionais
      allow write: if isAdmin() || isProfessional();

      // Subcoleção: logs de execução de automações (somente leitura pelo cliente)
      match /automation_logs/{logId} {
        allow read: if isAuthenticated() && hasProfile() && organizationId == userOrgId();
        allow create, update, delete: if false;
      }

      // Subcoleção: status de integrações (last_sync_at, sync_status)
      match /integration_status/{providerId} {
        allow read, write: if isAuthenticated() && hasProfile() && organizationId == userOrgId();
      }
    }
    
    // ============================================================================================
    // PROFILES COLLECTION (ADDED)
    // ============================================================================================
    
    match /profiles/{userId} {
      // Leitura: qualquer usuário autenticado pode ler perfis (com restrições de aplicação)
      // Isso evita dependência circular com hasRole()
      allow read: if isAuthenticated();

      // Criação: qualquer usuário autenticado pode criar seu próprio perfil
      allow create: if isAuthenticated() && request.auth.uid == userId && isValidSize();

      // Atualização: apenas o próprio usuário ou admin
      // Admin pode atualizar qualquer perfil
      // Usuário comum não pode alterar campos sensíveis
      allow update: if isAdmin() || 
                      (isAuthenticated() && request.auth.uid == userId && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'organization_id', 'permissions']));

      // Deleção: apenas admin
      allow delete: if isAdmin();
    }
    
    // ============================================================================================
    // ONBOARDING PROGRESS COLLECTION (ADDED)
    // ============================================================================================
    
    match /onboarding_progress/{userId} {
      // Leitura/Escrita: apenas o próprio usuário
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================================================================
    // USER ROLES COLLECTION (ADDED)
    // ============================================================================================
    
    match /user_roles/{userId} {
      allow read: if isAdmin() || isProfessional() || (isAuthenticated() && request.auth.uid == userId);
      // Escrita apenas por admin via backend (idealmente) ou regras mais estritas
      allow write: if isAdmin();
    }

    // ============================================================================================
    // PATIENTS COLLECTION
    // ============================================================================================

    match /patients {
      allow list, get: if isAuthenticated();
    }

    match /patients/{patientId} {
      allow read: if isAuthenticated();

      // Criação: profissionais, admin, ou usuários autenticados sem perfil (para onboarding)
      allow create: if (isProfessional() || isAdmin() || (isAuthenticated() && !hasProfile())) && isValidSize();

      // Atualização: profissionais podem atualizar pacientes que atendem
      // pacientes podem atualizar dados limitados
      allow update: if isProfessional() || isAdmin() ||
                      (isPatient() && isOwner('userId'));

      // Deleção: apenas admins
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // APPOINTMENTS COLLECTION
    // ============================================================================================

    match /appointments {
      allow list, get: if isAuthenticated();
    }

    match /appointments/{appointmentId} {
      allow read: if isAuthenticated();

      // Criação: profissionais, admin, ou usuários autenticados sem perfil
      allow create: if (isProfessional() || isAdmin() || (isAuthenticated() && !hasProfile())) && isValidSize();

      // Atualização: profissionais que atendem, admin
      allow update: if isProfessional() || isAdmin();

      // Deleção: apenas admin
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // PATIENT SUB-COLLECTIONS (Evolução de Sessão)
    // ============================================================================================

    match /patient_surgeries/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /patient_medical_returns/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /patient_pathologies/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /patient_goals/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /soap_records/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /treatment_sessions/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /evolution_measurements/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /pathology_required_measurements/{docId} {
      allow read, write: if isAuthenticated();
    }

    // ============================================================================================
    // EXERCISES COLLECTION
    // ============================================================================================

    match /exercises/{exerciseId} {
      // Leitura: apenas admin ou profissionais (biblioteca de exercícios)
      allow read: if isAdmin() || isProfessional();

      // Criação: profissionais e admin
      allow create: if isProfessional() && isValidSize();

      // Atualização: apenas criador e admin
      allow update: if isProfessional() && isOwner('createdBy') ||
                      isAdmin();

      // Deleção: apenas admin
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // EXERCISE PROTOCOLS COLLECTION (Protocolos Clínicos)
    // ============================================================================================

    match /exercise_protocols/{protocolId} {
      // Leitura: admin ou profissionais (página Protocolos)
      allow read: if isAdmin() || isProfessional();

      // Criação: profissionais e admin
      allow create: if (isProfessional() || isAdmin()) && isValidSize();

      // Atualização: profissionais e admin
      allow update: if isProfessional() || isAdmin();

      // Deleção: profissionais e admin
      allow delete: if isProfessional() || isAdmin();
    }

    // ============================================================================================
    // EXERCISE TEMPLATES (aba Templates em /exercises)
    // ============================================================================================

    match /exercise_templates/{templateId} {
      allow read: if isAdmin() || isProfessional();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update, delete: if isProfessional() || isAdmin();
    }

    match /exercise_template_items/{itemId} {
      allow read: if isAdmin() || isProfessional();
      allow create: if (isProfessional() || isAdmin()) && isValidSize();
      allow update, delete: if isProfessional() || isAdmin();
    }

    // ============================================================================================
    // CLINICAL TEST TEMPLATES (PhysioTests DB / Testes Clínicos)
    // ============================================================================================

    match /clinical_test_templates/{docId} {
      // Leitura: admin ou profissionais (página /clinical-tests e combobox)
      allow read: if isAdmin() || isProfessional();

      // Criação: profissionais e admin
      allow create: if (isProfessional() || isAdmin()) && isValidSize();

      // Atualização e deleção: profissionais e admin
      allow update, delete: if isProfessional() || isAdmin();
    }

    // ============================================================================================
    // FINANCIAL / PAYMENTS / CONTAS_FINANCEIRAS COLLECTION
    // ============================================================================================

    match /contas_financeiras/{id} {
        allow read: if isAdmin() || isProfessional();
        allow write: if isAdmin();
    }

    match /payments/{paymentId} {
      // Acesso restrito: apenas admin
      allow read, write: if isAdmin();
    }
    
    match /vouchers/{voucherId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if false; 
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================================================

    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow create: if false; 
      allow update: if isAuthenticated() && request.auth.uid == resource.data.user_id;
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.user_id || isAdmin();
    }

    // ============================================================================================
    // AUDIT LOGS COLLECTION
    // ============================================================================================

    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // ============================================================================================
    // SETTINGS COLLECTION
    // ============================================================================================

    match /settings/{settingId} {
      allow read: if isAuthenticated() && (!resource.data.isPrivate || isAdmin());
      allow write: if isAdmin();
    }
    
    // ============================================================================================
    // EVENTS COLLECTION
    // ============================================================================================

    match /events/{eventId} {
      allow read: if canAccessPatientData() || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isOwner('createdBy') || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================================================================
    // EVOLUTIONS / MEDICAL RECORDS / EVALUATIONS
    // ============================================================================================

    match /evolutions/{evolutionId} {
      allow read: if canAccessPatientData() || (isPatient() && resource.data.patientId == request.auth.uid) || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isOwner('therapistId') || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /evaluations/{evaluationId} {
      allow read: if canAccessPatientData() || (isPatient() && resource.data.patientId == request.auth.uid) || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isOwner('therapistId') || isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // SCHEDULE SETTINGS (Configurações da Agenda)
    // ============================================================================================
    // Acesso a doc da agenda por organização do perfil (leitura: resource, escrita: request.resource)
    function canAccessScheduleDoc() {
      return (resource != null && resource.data.organization_id != null && canAccessScheduleByOrg(resource.data.organization_id))
        || (request.resource != null && request.resource.data.organization_id != null && canAccessScheduleByOrg(request.resource.data.organization_id));
    }
    // Capacidade por horário (Configurações da Agenda > Capacidade)
    match /schedule_capacity_config/{docId} {
      allow read: if isAuthenticated();
      allow write: if canManageSchedule();
    }
    // Horários de funcionamento (Configurações da Agenda > Horários)
    match /schedule_business_hours/{docId} {
      allow read, write: if isValidSize() && (isBootstrapAdmin() || canManageSchedule() || canAccessScheduleDoc());
    }
    // Regras de cancelamento (Configurações da Agenda > Cancelamento)
    match /schedule_cancellation_rules/{docId} {
      allow read, write: if isValidSize() && (isBootstrapAdmin() || canManageSchedule() || canAccessScheduleDoc());
    }
    // Notificações da agenda (Configurações da Agenda > Notificações)
    match /schedule_notification_settings/{docId} {
      allow read, write: if isValidSize() && (isBootstrapAdmin() || canManageSchedule() || canAccessScheduleDoc());
    }
    // Horários bloqueados (Configurações da Agenda > Bloqueios)
    match /schedule_blocked_times/{docId} {
      allow read, write: if isValidSize() && (isBootstrapAdmin() || canManageSchedule() || canAccessScheduleDoc());
    }

    // ============================================================================================
    // WAITLIST (Lista de Espera) - Firestore migration
    // ============================================================================================
    match /waitlist/{waitlistId} {
      // Visualizar e manipular itens da lista de espera somente por quem gerencia agenda
      allow read: if canManageSchedule();
      allow create: if isValidSize() && canManageSchedule();
      allow update: if canManageSchedule();
      // Deleção completa apenas por admin; normalmente usamos update para marcar como removed
      allow delete: if isAdmin();
    }

    // Ofertas de vaga associadas à lista de espera
    match /waitlist_offers/{offerId} {
      allow read: if canManageSchedule();
      allow create, update: if isValidSize() && canManageSchedule();
      allow delete: if isAdmin();
    }

    // Presence (usuários online) - cada usuário só escreve/lê o próprio doc
    match /presence/{channelName}/users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId && isValidSize();
    }

    // Wiki / Knowledge Base (Fase 2 - Pente Fino)
    match /wiki_pages/{pageId} {
      allow read: if isAuthenticated() && hasProfile() && resource.data.organization_id == userOrgId();
      allow create: if isAuthenticated() && hasProfile() && request.resource.data.organization_id == userOrgId() && isValidSize();
      allow update, delete: if isAuthenticated() && hasProfile() && resource.data.organization_id == userOrgId() && isValidSize();
    }
    match /wiki_categories/{categoryId} {
      allow read: if isAuthenticated() && hasProfile() && resource.data.organization_id == userOrgId();
      allow create: if isAuthenticated() && hasProfile() && request.resource.data.organization_id == userOrgId() && isValidSize();
      allow update, delete: if isAuthenticated() && hasProfile() && resource.data.organization_id == userOrgId() && isValidSize();
    }

    // Convites de usuários (createUserInvitation, getInvitationByToken, consumeInvitation)
    match /user_invitations/{invitationId} {
      allow read, create, update, delete: if isAuthenticated();
    }

    // ============================================================================================
    // GAMIFICATION COLLECTIONS
    // ============================================================================================

    // Perfis de gamificação de pacientes
    match /patient_gamification/{patientId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // Transações de XP
    match /xp_transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isProfessional() || isAdmin();
    }

    // Conquistas (achievements) disponíveis
    match /achievements/{achievementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Log de conquistas desbloqueadas por pacientes
    match /achievements_log/{logId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update, delete: if isAdmin();
    }

    // Missões diárias
    match /daily_quests/{questId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // Itens da loja
    match /shop_items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Inventário do usuário
    match /user_inventory/{inventoryId} {
      allow read: if isAuthenticated();
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // Configurações de gamificação
    match /gamification_settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================================================================
    // DOCTORS COLLECTION
    // ============================================================================================

    match /doctors {
      allow list: if isAuthenticated();
    }

    match /doctors/{doctorId} {
      // Leitura: qualquer usuário autenticado pode ver médicos
      allow read: if isAuthenticated();

      // Criação: profissionais e admin podem criar médicos
      allow create: if (isProfessional() || isAdmin()) && isValidSize();

      // Atualização: profissionais e admin podem atualizar médicos
      allow update: if isProfessional() || isAdmin();

      // Soft delete: profissionais e admin podem desativar médicos
      // Hard delete: apenas admin
      allow delete: if isAdmin();
    }

    // ============================================================================================
    // MARKETING COLLECTIONS (Marketing Module v2.0)
    // ============================================================================================

    // Consentimentos de Marketing (LGPD)
    match /marketing_consents/{patientId} {
      // Leitura: profissionais precisam verificar consentimento
      allow read: if isProfessional() || isAdmin() || (isPatient() && request.auth.uid == patientId);
      // Criação/Atualização: profissionais podem criar/atualizar
      allow create, update: if isProfessional() || isAdmin();
      // Deleção: apenas admin (para compliance LGPD)
      allow delete: if isAdmin();
    }

    // Exportações de Marketing (vídeos, imagens)
    match /marketing_exports/{exportId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Configurações de Marketing (automações)
    match /marketing_configs/{configId} {
      allow read: if isProfessional() || isAdmin();
      allow write: if isAdmin() || (isProfessional() && canManageSchedule());
    }

    // Campanhas de Recall
    match /recall_campaigns/{campaignId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isProfessional() && isValidSize();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // Códigos de Indicação (MGM - Member Get Member)
    match /referral_codes/{codeId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Resgates de Códigos de Indicação
    match /referral_redemptions/{redemptionId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isAuthenticated() && isValidSize(); //任何人都可以redeem
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // FisioLink (link na bio)
    match /fisio_links/{slug} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // Analytics do FisioLink
    match /fisio_link_analytics/{analyticId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isAuthenticated(); // anonymous tracking
      allow update, delete: if isAdmin();
    }

    // Calendário de Conteúdo
    match /content_calendar/{contentId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isProfessional() || isAdmin();
      allow update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // Pontos de Gamificação de Adesão
    match /gamification_points/{patientId} {
      allow read: if isProfessional() || isAdmin() || (isPatient() && request.auth.uid == patientId);
      allow create, update: if isProfessional() || isAdmin();
      allow delete: if isAdmin();
    }

    // Conquistas de Marketing desbloqueadas
    match /marketing_achievements/{achievementId} {
      allow read: if isAuthenticated();
      allow create: if isProfessional() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Logs de conquistas de marketing
    match /marketing_achievement_log/{logId} {
      allow read: if isProfessional() || isAdmin();
      allow create: if isProfessional() || isAdmin();
      allow update, delete: if isAdmin();
    }

    // Rankings de marketing (leaderboards)
    match /marketing_leaderboards/{leaderboardId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================================================================
    // USER SUB-COLLECTIONS (Patient App Data)
    // ============================================================================================

    // Exercise plans for patients
    match /users/{userId}/exercise_plans/{planId} {
      // Patients can read their own exercise plans
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Professionals can read their patients' plans
      allow read: if isProfessional();
      // Only professionals can create/update plans
      allow create, update: if isProfessional() || isAdmin();
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // Appointments for patients
    match /users/{userId}/appointments/{appointmentId} {
      // Patients can read their own appointments
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Professionals can read appointments they're involved in
      allow read: if isProfessional();
      // Only professionals can create/update appointments
      allow create, update: if isProfessional() || isAdmin();
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // Health data (HealthKit/Health Connect integration)
    match /users/{userId}/health_data/{dataId} {
      // Patients can read/write their own health data
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // Professionals can read health data (read-only)
      allow read: if isProfessional();
    }

    // Pain entries (PainMap data)
    match /users/{userId}/pain_entries/{entryId} {
      // Patients can read/write their own pain entries
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // Professionals can read pain entries (read-only)
      allow read: if isProfessional();
    }

    // Messages and conversations
    match /conversations/{conversationId} {
      // Participants can read their conversations
      allow read: if isAuthenticated() &&
        exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid));
      // Authenticated users can create conversations
      allow create: if isAuthenticated() && isValidSize();
      // Participants can update conversations
      allow update: if isAuthenticated() &&
        exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid));
      // Only admin can delete conversations
      allow delete: if isAdmin();
    }

    // Conversation participants
    match /conversations/{conversationId}/participants/{participantId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Messages within conversations
    match /conversations/{conversationId}/messages/{messageId} {
      // Participants can read messages
      allow read: if isAuthenticated() &&
        exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid));
      // Participants can send messages
      allow create: if isAuthenticated() &&
        exists(/databases/$(database)/documents/conversations/$(conversationId)/participants/$(request.auth.uid)) &&
        isValidSize();
      // Only sender can update their own messages
      allow update: if isAuthenticated() &&
        request.auth.uid == resource.data.senderId;
      // Only admin can delete messages
      allow delete: if isAdmin();
    }

    // User profile photos (stored in users/{userId}/profile_photos/{photoId})
    match /users/{userId}/profile_photos/{photoId} {
      // Users can read their own profile photos
      allow read: if isAuthenticated();
      // Users can upload their own photos
      allow create: if isAuthenticated() && request.auth.uid == userId && isValidSize();
      // Only owner can update their photos
      allow update: if isAuthenticated() && request.auth.uid == userId;
      // Only owner or admin can delete
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // Exercise progress tracking
    match /users/{userId}/exercise_progress/{progressId} {
      // Patients can read/write their own progress
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // Professionals can read progress (read-only)
      allow read: if isProfessional();
    }

    // Notification preferences
    match /users/{userId}/notification_settings/{settingId} {
      // Users can read/write their own notification settings
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
